"use strict";const c=require("electron"),f=require("node:path"),u=require("node:fs"),re=require("child_process"),se=require("https"),ae=require("http"),oe=require("events"),ne=require("path"),T=require("fs"),ie=require("crypto"),_=f.join(c.app.getPath("userData"),"plugins"),$=f.join(c.app.getPath("userData"),"plugin-settings.json"),B=()=>{u.existsSync(_)||u.mkdirSync(_,{recursive:!0})},N=()=>{try{if(u.existsSync($))return JSON.parse(u.readFileSync($,"utf-8"))}catch(r){console.error("[PluginHandler] Error loading settings:",r)}return{installedPlugins:{}}},U=r=>{try{u.writeFileSync($,JSON.stringify(r,null,2))}catch(t){console.error("[PluginHandler] Error saving settings:",t)}},F=r=>new Promise((t,e)=>{(r.startsWith("https")?se:ae).get(r,s=>{if(s.statusCode===301||s.statusCode===302){const o=s.headers.location;if(o){F(o).then(t).catch(e);return}}if(s.statusCode!==200){e(new Error(`HTTP ${s.statusCode}`));return}const n=[];s.on("data",o=>n.push(o)),s.on("end",()=>t(Buffer.concat(n))),s.on("error",e)}).on("error",e)}),V=r=>{try{const t=f.join(r,"plugin.json");if(u.existsSync(t))return JSON.parse(u.readFileSync(t,"utf-8"))}catch(t){console.error("[PluginHandler] Error reading manifest:",t)}return null},ce=()=>{B(),c.ipcMain.handle("plugins-list",async()=>{try{B();const r=[],t=u.readdirSync(_);for(const e of t){const a=f.join(_,e);if(u.statSync(a).isDirectory()){const s=V(a);s&&r.push(s)}}return r}catch(r){return console.error("[PluginHandler] List error:",r),[]}}),c.ipcMain.handle("plugins-load-code",async(r,t)=>{try{const e=f.join(_,t),a=V(e);if(!a)throw new Error("Plugin manifest not found");const s=f.join(e,a.entry);if(!u.existsSync(s))throw new Error("Plugin entry file not found");return u.readFileSync(s,"utf-8")}catch(e){throw console.error("[PluginHandler] Load code error:",e),e}}),c.ipcMain.handle("plugins-install-url",async(r,t)=>{try{console.log("[PluginHandler] Installing from URL:",t);const e=await F(t),a=f.join(c.app.getPath("temp"),`plugin-${Date.now()}`);if(u.mkdirSync(a,{recursive:!0}),t.endsWith(".js")){const s=f.basename(t,".js"),n=f.join(_,s);u.mkdirSync(n,{recursive:!0}),u.writeFileSync(f.join(n,"index.js"),e);const o={id:s,name:s,version:"1.0.0",author:"Unknown",description:"Plugin installed from URL",type:"metadata",entry:"index.js",abilities:[],apis:["fetch"]};return u.writeFileSync(f.join(n,"plugin.json"),JSON.stringify(o,null,2)),{success:!0,manifest:o}}if(t.endsWith(".json")||t.includes("plugin.json")){const s=JSON.parse(e.toString()),n=f.join(_,s.id);if(u.mkdirSync(n,{recursive:!0}),u.writeFileSync(f.join(n,"plugin.json"),e),s.entry){const i=`${t.substring(0,t.lastIndexOf("/"))}/${s.entry}`,l=await F(i);u.writeFileSync(f.join(n,s.entry),l)}return{success:!0,manifest:s}}return{success:!1,error:"Unsupported plugin format"}}catch(e){return console.error("[PluginHandler] Install URL error:",e),{success:!1,error:e.message}}}),c.ipcMain.handle("plugins-install-file",async(r,t,e)=>{try{console.log("[PluginHandler] Installing from file:",e);const a=Buffer.from(t);if(e.endsWith(".js")){const s=f.basename(e,".js"),n=f.join(_,s);u.mkdirSync(n,{recursive:!0}),u.writeFileSync(f.join(n,"index.js"),a);const o={id:s,name:s,version:"1.0.0",author:"Unknown",description:"Plugin installed from file",type:"metadata",entry:"index.js",abilities:[],apis:["fetch"]};return u.writeFileSync(f.join(n,"plugin.json"),JSON.stringify(o,null,2)),{success:!0,manifest:o}}return{success:!1,error:"Unsupported file format"}}catch(a){return console.error("[PluginHandler] Install file error:",a),{success:!1,error:a.message}}}),c.ipcMain.handle("plugins-uninstall",async(r,t)=>{try{const e=f.join(_,t);u.existsSync(e)&&u.rmSync(e,{recursive:!0,force:!0});const a=N();return delete a.installedPlugins[t],U(a),!0}catch(e){return console.error("[PluginHandler] Uninstall error:",e),!1}}),c.ipcMain.handle("plugins-get-settings",async()=>N()),c.ipcMain.handle("plugins-save-settings",async(r,t)=>(U(t),!0)),console.log("[PluginHandler] Initialized")},A=ne.join(c.app.getPath("userData"),"spotify-session.json"),le="https://codeberg.org/sonic-liberation/blubber-junkyard-elitism/raw/branch/main/nuances.json";class ue extends oe.EventEmitter{_spDc=null;_accessToken=null;_expiration=0;_nuance=null;constructor(){super(),this._loadSession()}get accessToken(){return this._accessToken}get expiration(){return this._expiration}get spDc(){return this._spDc}_loadSession(){try{if(T.existsSync(A)){const t=JSON.parse(T.readFileSync(A,"utf-8"));this._spDc=t.spDcCookie,this._accessToken=t.accessToken,this._expiration=t.expiration,this.isAuthenticated()&&(console.log("[SpotifyAuth] Recovered session from disk"),this.emit("recovered"))}}catch(t){console.error("[SpotifyAuth] Failed to load session:",t)}}_saveSession(){try{const t={spDcCookie:this._spDc||"",accessToken:this._accessToken||"",expiration:this._expiration,savedAt:Date.now()};T.writeFileSync(A,JSON.stringify(t,null,2))}catch(t){console.error("[SpotifyAuth] Failed to save session:",t)}}isAuthenticated(){return!!this._accessToken&&this._expiration>Date.now()}async loginWithSpDc(t){try{this._spDc=t,console.log("[SpotifyAuth] Starting TOTP login..."),this._nuance||await this._fetchNuance();const e=await this._getServerTime(),a=this._generateTotp(e);console.log(`[SpotifyAuth] Using TOTP v${this._nuance?.v||0}...`);const s=await this._fetchToken(a);if(s.accessToken)return this._accessToken=s.accessToken,this._expiration=s.accessTokenExpirationTimestampMs||Date.now()+36e5,this._saveSession(),this.emit("login",{accessToken:this._accessToken}),console.log("[SpotifyAuth] Login successful!"),{success:!0,accessToken:this._accessToken??void 0,expiration:this._expiration};throw new Error(s.error||"No access token in response")}catch(e){return console.error("[SpotifyAuth] Login failed:",e.message),{success:!1,error:e.message}}}async refreshCredentials(){return this._spDc?this.loginWithSpDc(this._spDc):{success:!1,error:"No sp_dc cookie stored"}}logout(){this._spDc=null,this._accessToken=null,this._expiration=0;try{T.existsSync(A)&&T.unlinkSync(A)}catch{}this.emit("logout")}async _fetchNuance(){try{const t=(await Promise.resolve().then(()=>require("./index-CJj3cZv8.js"))).default,e=await t(le,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});if(!e.ok)throw new Error(`Failed to fetch nuance: ${e.status}`);const a=await e.json();a.sort((n,o)=>(o.v||0)-(n.v||0));const s=a[0];if(s&&s.s)this._nuance={v:s.v||1,s:s.s},console.log(`[SpotifyAuth] Nuance fetched: v${this._nuance.v}`);else throw new Error("Invalid nuance format")}catch(t){console.warn("[SpotifyAuth] Nuance fetch failed, using fallback:",t.message),this._nuance={v:5,s:"GVPZVYTFNAZ27PYEXKQ7X5YAFGC3CHBD"}}}async _getServerTime(){try{const t=(await Promise.resolve().then(()=>require("./index-CJj3cZv8.js"))).default,e=await t("https://open.spotify.com/api/server-time",{headers:{Cookie:`sp_dc=${this._spDc}`,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});if(e.ok)return(await e.json()).serverTime||Math.floor(Date.now()/1e3)}catch{}return Math.floor(Date.now()/1e3)}_generateTotp(t){const e=this._nuance?.s||"GVPZVYTFNAZ27PYEXKQ7X5YAFGC3CHBD",a=Math.floor(t/30),s="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let n="";for(const m of e.toUpperCase()){const k=s.indexOf(m);k>=0&&(n+=k.toString(2).padStart(5,"0"))}const o=Buffer.alloc(Math.floor(n.length/8));for(let m=0;m<o.length;m++)o[m]=parseInt(n.substring(m*8,(m+1)*8),2);const i=Buffer.alloc(8);i.writeBigInt64BE(BigInt(a));const l=ie.createHmac("sha1",o);l.update(i);const p=l.digest(),d=p[p.length-1]&15;return(((p[d]&127)<<24|(p[d+1]&255)<<16|(p[d+2]&255)<<8|p[d+3]&255)%1e6).toString().padStart(6,"0")}async _fetchToken(t){const e=this._nuance?.v||5,a=`https://open.spotify.com/api/token?reason=transport&productType=web-player&totp=${t}&totpServer=${t}&totpVer=${e}`;return console.log(`[SpotifyAuth] Fetching token from: /api/token?...totpVer=${e}`),new Promise((s,n)=>{const o=c.net.request({method:"GET",url:a,useSessionCookies:!1});o.setHeader("Cookie",`sp_dc=${this._spDc}`),o.setHeader("User-Agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"),o.setHeader("Accept","application/json"),o.setHeader("Accept-Language","en-US,en;q=0.9"),o.setHeader("Referer","https://open.spotify.com/"),o.setHeader("Origin","https://open.spotify.com");let i="";o.on("response",l=>{if(l.statusCode!==200){let p="";l.on("data",d=>{p+=d.toString()}),l.on("end",()=>{console.error("[SpotifyAuth] Token error:",l.statusCode,p.substring(0,200)),n(new Error(`Token fetch failed: HTTP ${l.statusCode}`))});return}l.on("data",p=>{i+=p.toString()}),l.on("end",()=>{try{const p=JSON.parse(i);p.accessToken&&console.log("[SpotifyAuth] Got access token, length:",p.accessToken.length),s(p)}catch{n(new Error("Failed to parse token response"))}})}),o.on("error",l=>{n(l)}),o.end()})}}const P=new ue,pe="https://api-partner.spotify.com/pathfinder/v1/query",b={profileAttributes:"53bcb064f6cd18c23f752bc324a791194d20df612d8e1239c735144ab0399ced",fetchLibraryTracks:"087278b20b743578a6262c2b0b4bcd20d879c503cc359a2285baf083ef944240",libraryV3:"2de10199b2441d6e4ae875f27d2db361020c399fb10b03951120223fbed10b08",fetchPlaylist:"bb67e0af06e8d6f52b531f97468ee4acd44cd0f82b988e15c2ea47b1148efc77",getAlbum:"b9bfabef66ed756e5e13f68a942deb60bd4125ec1f1be8cc42769dc0259b4b10",getTrack:"612585ae06ba435ad26369870deaae23b5c8800a256cd8a57e08eddc25a37294",queryArtistOverview:"446130b4a0aa6522a686aafccddb0ae849165b5e0436fd802f96e0243617b5d8",searchDesktop:"4801118d4a100f756e833d33984436a3899cff359c532f8fd3aaf174b60b3b49",searchTracks:"bc1ca2fcd0ba1013a0fc88e6cc4f190af501851e3dafd3e1ef85840297694428",searchAlbums:"a71d2c993fc98e1c880093738a55a38b57e69cc4ce5a8c113e6c5920f9513ee2",isCurated:"e4ed1f91a2cc5415befedb85acf8671dc1a4bf3ca1a5b945a6386101a22e28a6",addToLibrary:"a3c1ff58e6a36fec5fe1e3a193dc95d9071d96b9ba53c5ba9c1494fb1ee73915",removeFromLibrary:"a3c1ff58e6a36fec5fe1e3a193dc95d9071d96b9ba53c5ba9c1494fb1ee73915",home:"d62af2714f2623c923cc9eeca4b9545b4363abaa9188a9e94e2b63b823419a2c"};async function w(r,t,e={}){const a=P.accessToken;if(!a)throw new Error("Not authenticated");const s=JSON.stringify({variables:e,operationName:r,extensions:{persistedQuery:{version:1,sha256Hash:t}}});return new Promise((n,o)=>{const i=c.net.request({method:"POST",url:pe});i.setHeader("Authorization",`Bearer ${a}`),i.setHeader("Content-Type","application/json"),i.setHeader("Accept","application/json"),i.setHeader("User-Agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36");let l="";i.on("response",p=>{p.on("data",d=>{l+=d.toString()}),p.on("end",()=>{try{const d=JSON.parse(l);d.errors?(console.error("[GQL] Error:",d.errors[0]?.message),o(new Error(d.errors[0]?.message||"GraphQL error"))):n(d)}catch{o(new Error("Failed to parse GraphQL response"))}})}),i.on("error",o),i.write(s),i.end()})}async function de(){const t=(await w("profileAttributes",b.profileAttributes,{})).data?.me?.profile;if(!t)throw new Error("Failed to get user profile");const e=t.uri?.split(":").pop();return{id:e,display_name:t.name,email:"unknown",images:t.avatar?.sources||[],uri:t.uri,external_urls:{spotify:`https://open.spotify.com/user/${e}`},type:"user"}}async function fe(r=0,t=20){const a=(await w("fetchLibraryTracks",b.fetchLibraryTracks,{offset:r,limit:t})).data?.me?.library;if(!a)throw new Error("Failed to get saved tracks");const s=a.tracks?.items?.map(n=>{const o=n.track?.data;if(!o)return null;const i=n.track?._uri?.split(":").pop(),l=o.artists?.items?.map(h=>{const m=h.uri?.split(":").pop();return{id:m,name:h.profile?.name,uri:h.uri,external_urls:{spotify:`https://open.spotify.com/artist/${m}`}}})||[],p=o.albumOfTrack?.uri?.split(":").pop(),d=o.duration?.totalMilliseconds||0;return{track:{id:i,name:o.name,uri:`spotify:track:${i}`,duration_ms:d,artists:l,album:{id:p,name:o.albumOfTrack?.name,images:o.albumOfTrack?.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${p}`}},external_urls:{spotify:`https://open.spotify.com/track/${i}`}}}}).filter(Boolean)||[];return{items:s,total:a.tracks?.totalCount||0,offset:r,limit:t,next:s.length===t?`offset=${r+t}`:null}}async function he(r=0,t=20){const a=(await w("libraryV3",b.libraryV3,{filters:["Playlists"],order:null,textFilter:"",features:["LIKED_SONGS","YOUR_EPISODES_V2","PRERELEASES","EVENTS"],limit:t,offset:r,flatten:!1,expandedFolders:[],folderUri:null,includeFoldersWhenFlattening:!0})).data?.me?.libraryV3;if(!a)throw new Error("Failed to get playlists");return{items:a.items?.filter(n=>n.item?.__typename==="PlaylistResponseWrapper"&&n.item?.data?.__typename==="Playlist").map(n=>{const o=n.item?._uri?.split(":").pop(),i=n.item?.data,l=i?.ownerV2?.data;return{id:o,name:i?.name,description:i?.description,images:i?.images?.items?.flatMap(p=>p.sources)||[],uri:n.item?._uri,external_urls:{spotify:`https://open.spotify.com/playlist/${o}`},owner:{id:l?.id,display_name:l?.name,uri:l?.uri,images:l?.avatar?.sources||[]},tracks:{total:0}}})||[],total:a.totalCount||0,offset:a.pagingInfo?.offset||r,limit:a.pagingInfo?.limit||t}}async function me(r){const e=(await w("fetchPlaylist",b.fetchPlaylist,{uri:`spotify:playlist:${r}`,offset:0,limit:25,enableWatchFeedEntrypoint:!0})).data?.playlistV2;if(!e)throw new Error("Failed to get playlist");const a=e.ownerV2?.data;return{id:r,name:e.name,description:e.description,collaborative:(e.members?.items?.length||0)>1,public:!0,images:e.images?.items?.[0]?.sources||[],uri:`spotify:playlist:${r}`,external_urls:{spotify:`https://open.spotify.com/playlist/${r}`},owner:{id:a?.uri?.split(":").pop(),display_name:a?.name,uri:a?.uri,images:a?.avatar?.sources||[]},followers:e.followers,tracks:{total:e.content?.totalCount||0}}}async function ye(r,t=0,e=25){const s=(await w("fetchPlaylist",b.fetchPlaylist,{uri:`spotify:playlist:${r}`,offset:t,limit:e,enableWatchFeedEntrypoint:!1})).data?.playlistV2;if(!s)throw new Error("Failed to get playlist tracks");const n=s.content?.items?.map(o=>{const i=o.itemV2?.data;if(!i)return null;Math.random()<.05&&(console.log("[GQL] Playlist Track Item Keys:",Object.keys(i)),console.log("[GQL] Playlist Track Duration:",JSON.stringify(i.duration)));const l=i.uri?.split(":").pop(),p=i.artists?.items?.map(m=>{const k=m.uri?.split(":").pop();return{id:k,uri:m.uri,name:m.profile?.name,external_urls:{spotify:`https://open.spotify.com/artist/${k}`}}})||[],d=i.albumOfTrack?.uri?.split(":").pop(),h=i.duration?.totalMilliseconds||i.trackDuration?.totalMilliseconds||0;return{id:l,uri:i.uri,name:i.name,album:{album_type:"album",id:d,name:i.albumOfTrack?.name,images:i.albumOfTrack?.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${d}`},artists:[p[0]]},artists:p,duration_ms:h,external_urls:{spotify:`https://open.spotify.com/track/${l}`}}}).filter(Boolean)||[];return{items:n.map(o=>({track:o})),total:s.content?.totalCount||0,offset:t,limit:e,next:n.length===e?`offset=${t+e}`:null}}async function ge(r,t=0,e=10){const s=(await w("searchDesktop",b.searchDesktop,{searchTerm:r,offset:t,limit:e,numberOfTopResults:5,includeAudiobooks:!1,includeArtistHasConcertsField:!1,includePreReleases:!1,includeLocalConcertsField:!1,includeAuthors:!1})).data?.searchV2;if(!s)throw new Error("Search failed");return{tracks:q(s.tracksV2?.items||[]),albums:z(s.albumsV2?.items||[]),artists:J(s.artists?.items||[]),playlists:Y(s.playlists?.items||[])}}async function be(r,t=0,e=20){const s=(await w("searchTracks",b.searchTracks,{searchTerm:r,offset:t,limit:e,numberOfTopResults:20,includeAudiobooks:!0,includeAuthors:!1,includePreReleases:!1})).data?.searchV2?.tracksV2;if(!s)throw new Error("Track search failed");return{tracks:{items:q(s.items||[])},total:s.totalCount||0,offset:s.pagingInfo?.nextOffset||t,limit:s.pagingInfo?.limit||e}}async function we(r,t=0,e=20){const s=(await w("searchAlbums",b.searchAlbums,{searchTerm:r,offset:t,limit:e,numberOfTopResults:20,includeAudiobooks:!1,includeAuthors:!1,includePreReleases:!1})).data?.searchV2?.albumsV2;if(!s)throw new Error("Album search failed");return{albums:{items:z(s.items||[])},total:s.totalCount||0,offset:s.pagingInfo?.nextOffset||t,limit:s.pagingInfo?.limit||e}}async function ke(r,t=0,e=20){const s=(await w("searchDesktop",b.searchDesktop,{searchTerm:r,offset:t,limit:e,numberOfTopResults:20,includeAudiobooks:!1,includeAuthors:!1,includePreReleases:!1})).data?.searchV2;if(!s)throw new Error("Artist search failed");return{artists:{items:J(s.artists?.items||[])},total:s.artists?.totalCount||0,offset:t,limit:e}}async function Se(r,t=0,e=20){const s=(await w("searchDesktop",b.searchDesktop,{searchTerm:r,offset:t,limit:e,numberOfTopResults:20,includeAudiobooks:!1,includeAuthors:!1,includePreReleases:!1})).data?.searchV2;if(!s)throw new Error("Playlist search failed");return{playlists:{items:Y(s.playlists?.items||[])},total:s.playlists?.totalCount||0,offset:t,limit:e}}async function _e(r){const e=(await w("getAlbum",b.getAlbum,{uri:`spotify:album:${r}`,locale:"",offset:0,limit:50})).data?.albumUnion;if(!e)throw console.error("[GQL] getAlbum returned null"),new Error("Failed to get album");const a=e.artists?.items?.map(o=>{const i=o.uri?.split(":").pop();return{id:i,uri:o.uri,name:o.profile?.name,external_urls:{spotify:`https://open.spotify.com/artist/${i}`},images:o.visuals?.avatarImage?.sources||[]}})||[],n=(e.tracksV2?.items||[]).map(o=>{const i=o.track,l=i.uri?.split(":").pop(),p=i.artists?.items?.map(d=>{const h=d.uri?.split(":").pop();return{id:h,uri:d.uri,name:d.profile?.name,external_urls:{spotify:`https://open.spotify.com/artist/${h}`}}})||[];return{id:l,uri:i.uri,name:i.name,duration_ms:i.duration?.totalMilliseconds,explicit:i.contentRating?.label==="EXPLICIT",artists:p,album:{id:r,name:e.name,images:e.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${r}`}},external_urls:{spotify:`https://open.spotify.com/track/${l}`},externalUri:`https://open.spotify.com/track/${l}`}});return{id:r,name:e.name,album_type:e.type?.toLowerCase(),label:e.label,release_date:e.date?.isoString,release_date_precision:e.date?.precision||"day",images:e.coverArt?.sources||[],artists:a,external_urls:{spotify:`https://open.spotify.com/album/${r}`},externalUri:`https://open.spotify.com/album/${r}`,copyrights:e.copyrights?.copyright||[],tracks:{items:n,total:e.tracksV2?.totalCount||0}}}async function Te(r,t=0,e=50){const s=(await w("getAlbum",b.getAlbum,{uri:`spotify:album:${r}`,locale:"",offset:t,limit:e})).data?.albumUnion;if(!s)throw new Error("Failed to get album tracks");const n=s.tracksV2?.items||[],o={id:r,name:s.name,images:s.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${r}`}},i=n.map(l=>{const p=l.track,d=p.uri?.split(":").pop(),h=p.artists?.items?.map(m=>{const k=m.uri?.split(":").pop();return{id:k,uri:m.uri,name:m.profile?.name,external_urls:{spotify:`https://open.spotify.com/artist/${k}`}}})||[];return{id:d,uri:p.uri,name:p.name,duration_ms:p.duration?.totalMilliseconds,explicit:p.contentRating?.label==="EXPLICIT",artists:h,album:o,external_urls:{spotify:`https://open.spotify.com/track/${d}`},externalUri:`https://open.spotify.com/track/${d}`}});return{items:i,total:s.tracksV2?.totalCount||0,offset:t,limit:e,next:i.length<e?null:`offset=${t+e}`}}async function Ae(r){const e=(await w("queryArtistOverview",b.queryArtistOverview,{uri:`spotify:artist:${r}`,locale:""})).data?.artistUnion;if(!e)throw new Error("Failed to get artist");return{id:r,name:e.profile?.name,uri:`spotify:artist:${r}`,images:e.visuals?.avatarImage?.sources||[],followers:{total:e.stats?.followers||0},external_urls:{spotify:`https://open.spotify.com/artist/${r}`}}}async function ve(r){const e=(await w("queryArtistOverview",b.queryArtistOverview,{uri:`spotify:artist:${r}`,locale:""})).data?.artistUnion;if(!e)throw new Error("Failed to get artist top tracks");return{tracks:e.discography?.topTracks?.items?.map(s=>{const n=s.track;if(!n)return null;const o=n.uri?.split(":").pop(),i=n.artists?.items?.map(p=>{const d=p.uri?.split(":").pop();return{id:d,name:p.profile?.name,uri:p.uri,external_urls:{spotify:`https://open.spotify.com/artist/${d}`}}})||[],l=n.albumOfTrack?.uri?.split(":").pop();return{id:o,name:n.name,uri:n.uri,duration_ms:n.duration?.totalMilliseconds,artists:i,album:{id:l,name:n.albumOfTrack?.name,images:n.albumOfTrack?.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${l}`}},external_urls:{spotify:`https://open.spotify.com/track/${o}`}}}).filter(Boolean)||[]}}async function Pe(r){const e=(await w("getTrack",b.getTrack,{uri:`spotify:track:${r}`})).data?.trackUnion;if(!e)throw new Error("Failed to get track");const s=[...e.firstArtist?.items||[],...e.otherArtists?.items||[]].map(o=>{const i=o.uri?.split(":").pop();return{id:i,name:o.profile?.name,uri:o.uri,external_urls:{spotify:`https://open.spotify.com/artist/${i}`}}}),n=e.albumOfTrack?.uri?.split(":").pop();return{id:e.id,name:e.name,uri:e.uri,duration_ms:e.duration?.totalMilliseconds,artists:s,album:{id:n||e.albumOfTrack?.id,name:e.albumOfTrack?.name,images:e.albumOfTrack?.coverArt?.sources||[],album_type:e.albumOfTrack?.type?.toLowerCase(),release_date:e.albumOfTrack?.date?.isoString,external_urls:{spotify:`https://open.spotify.com/album/${n}`}},external_urls:{spotify:`https://open.spotify.com/track/${e.id}`}}}async function Ee(r){return((await w("isCurated",b.isCurated,{uris:r.map(a=>`spotify:track:${a}`)})).data?.lookup||[]).filter(a=>a.data?.__typename==="Track").map(a=>a.data?.isCurated||!1)}async function xe(r){return w("addToLibrary",b.addToLibrary,{uris:r.map(t=>`spotify:track:${t}`)})}async function Me(r){return w("removeFromLibrary",b.removeFromLibrary,{uris:r.map(t=>`spotify:track:${t}`)})}async function Ce(r="Asia/Kolkata",t=20){const a=(await w("home",b.home,{timeZone:r,sp_t:"",facet:"",sectionItemsLimit:t})).data?.home;return a?(a.sectionContainer?.sections?.items||[]).filter(n=>n.data?.__typename==="HomeGenericSectionData"&&n.sectionItems?.items?.length>0).map(n=>{const o=n.uri?.split(":").pop(),i=n.sectionItems?.items?.map(l=>{const p=l.content?.__typename,d=l.content?.data?.__typename;if(p==="PlaylistResponseWrapper"&&d==="Playlist"){const h=l.content.data,m=h.uri?.split(":").pop(),k=h.ownerV2?.data;return{type:"playlist",id:m,name:h.name,description:h.description,images:h.images?.items?.flatMap(te=>te.sources)||[],uri:h.uri,external_urls:{spotify:`https://open.spotify.com/playlist/${m}`},owner:{id:k?.uri?.split(":").pop(),display_name:k?.name}}}else if(p==="AlbumResponseWrapper"&&d==="Album"){const h=l.content.data,m=h.uri?.split(":").pop();return{type:"album",id:m,name:h.name,album_type:h.albumType?.toLowerCase(),images:h.coverArt?.sources||[],uri:h.uri,external_urls:{spotify:`https://open.spotify.com/album/${m}`},artists:h.artists?.items?.map(k=>({id:k.uri?.split(":").pop(),name:k.profile?.name}))||[]}}else if(p==="ArtistResponseWrapper"&&d==="Artist"){const h=l.content.data,m=h.uri?.split(":").pop();return{type:"artist",id:m,name:h.profile?.name,images:h.visuals?.avatarImage?.sources||[],uri:h.uri,external_urls:{spotify:`https://open.spotify.com/artist/${m}`}}}return null}).filter(Boolean)||[];return{id:o,title:n.data?.title?.transformedLabel||"Section",items:i}}).filter(n=>n.items?.length>0):[]}function q(r){return r.filter(t=>t.item?.__typename==="TrackResponseWrapper"&&t.item?.data?.__typename==="Track").map(t=>{const e=t.item.data,a=e.uri?.split(":").pop(),s=e.artists?.items?.map(o=>{const i=o.uri?.split(":").pop();return{id:i,name:o.profile?.name,uri:o.uri,external_urls:{spotify:`https://open.spotify.com/artist/${i}`}}})||[],n=e.albumOfTrack?.uri?.split(":").pop();return{id:a,name:e.name,uri:e.uri,duration_ms:e.duration?.totalMilliseconds,artists:s,album:{id:n,name:e.albumOfTrack?.name,images:e.albumOfTrack?.coverArt?.sources||[],external_urls:{spotify:`https://open.spotify.com/album/${n}`}},external_urls:{spotify:`https://open.spotify.com/track/${a}`}}})}function z(r){return r.filter(t=>t.__typename==="AlbumResponseWrapper"&&t.data?.__typename==="Album").map(t=>{const e=t.data,a=e.uri?.split(":").pop(),s=e.artists?.items?.map(n=>{const o=n.uri?.split(":").pop();return{id:o,name:n.profile?.name,uri:n.uri,external_urls:{spotify:`https://open.spotify.com/artist/${o}`}}})||[];return{id:a,name:e.name,album_type:e.type?.toLowerCase(),images:e.coverArt?.sources||[],artists:s,release_date:e.date?.year?.toString(),external_urls:{spotify:`https://open.spotify.com/album/${a}`}}})}function J(r){return r.filter(t=>t.__typename==="ArtistResponseWrapper"&&t.data?.__typename==="Artist").map(t=>{const e=t.data,a=e.uri?.split(":").pop();return{id:a,name:e.profile?.name,uri:e.uri,images:e.visuals?.avatarImage?.sources||[],external_urls:{spotify:`https://open.spotify.com/artist/${a}`}}})}function Y(r){return r.filter(t=>t.__typename==="PlaylistResponseWrapper"&&t.data?.__typename==="Playlist").map(t=>{const e=t.data,a=e.uri?.split(":").pop(),s=e.ownerV2?.data,n=s?.uri?.split(":").pop();return{id:a,name:e.name,description:e.description,uri:e.uri,images:e.images?.items?.flatMap(o=>o.sources)||[],external_urls:{spotify:`https://open.spotify.com/playlist/${a}`},owner:{id:n,display_name:s?.name,uri:s?.uri}}})}const g={user:{me:de,savedTracks:fe,savedPlaylists:he},playlist:{get:me,getTracks:ye},album:{get:_e,getTracks:Te},artist:{get:Ae,getTopTracks:ve},track:{get:Pe},search:{all:ge,tracks:be,albums:we,artists:ke,playlists:Se},library:{checkSavedTracks:Ee,saveTracks:xe,removeTracks:Me},browse:{home:Ce}};function De(){console.log("[SpotifyHandler] Initializing..."),c.ipcMain.handle("spotify:get-me",async()=>{try{return await g.user.me()}catch(r){throw console.error("[SpotifyHandler] get-me error:",r.message),r}}),c.ipcMain.handle("spotify:get-saved-tracks",async(r,t=20,e=0)=>{try{return await g.user.savedTracks(e,t)}catch(a){throw console.error("[SpotifyHandler] get-saved-tracks error:",a.message),a}}),c.ipcMain.handle("spotify:get-my-playlists",async(r,t=50,e=0)=>{try{return await g.user.savedPlaylists(e,t)}catch(a){throw console.error("[SpotifyHandler] get-my-playlists error:",a.message),a}}),c.ipcMain.handle("spotify:get-playlist",async(r,t)=>{try{return await g.playlist.get(t)}catch(e){throw console.error("[SpotifyHandler] get-playlist error:",e.message),e}}),c.ipcMain.handle("spotify:get-playlist-tracks",async(r,t,e=25,a=0)=>{try{return await g.playlist.getTracks(t,a,e)}catch(s){throw console.error("[SpotifyHandler] get-playlist-tracks error:",s.message),s}}),c.ipcMain.handle("spotify:get-album",async(r,t)=>{try{return await g.album.get(t)}catch(e){throw console.error("[SpotifyHandler] get-album error:",e.message),e}}),c.ipcMain.handle("spotify:get-album-tracks",async(r,t,e=0,a=50)=>{try{return await g.album.getTracks(t,e,a)}catch(s){throw console.error("[SpotifyHandler] get-album-tracks error:",s.message),s}}),c.ipcMain.handle("spotify:get-artist",async(r,t)=>{try{return await g.artist.get(t)}catch(e){throw console.error("[SpotifyHandler] get-artist error:",e.message),e}}),c.ipcMain.handle("spotify:get-artist-top-tracks",async(r,t)=>{try{return await g.artist.getTopTracks(t)}catch(e){throw console.error("[SpotifyHandler] get-artist-top-tracks error:",e.message),e}}),c.ipcMain.handle("spotify:get-track",async(r,t)=>{try{return await g.track.get(t)}catch(e){throw console.error("[SpotifyHandler] get-track error:",e.message),e}}),c.ipcMain.handle("spotify:search",async(r,t,e=0,a=10)=>{try{return await g.search.all(t,e,a)}catch(s){throw console.error("[SpotifyHandler] search error:",s.message),s}}),c.ipcMain.handle("spotify:search-tracks",async(r,t,e=0,a=20)=>{try{return await g.search.tracks(t,e,a)}catch(s){throw console.error("[SpotifyHandler] search-tracks error:",s.message),s}}),c.ipcMain.handle("spotify:search-albums",async(r,t,e=0,a=20)=>{try{return await g.search.albums(t,e,a)}catch(s){throw console.error("[SpotifyHandler] search-albums error:",s.message),s}}),c.ipcMain.handle("spotify:search-artists",async(r,t,e=0,a=20)=>{try{return await g.search.artists(t,e,a)}catch(s){throw console.error("[SpotifyHandler] search-artists error:",s.message),s}}),c.ipcMain.handle("spotify:search-playlists",async(r,t,e=0,a=20)=>{try{return await g.search.playlists(t,e,a)}catch(s){throw console.error("[SpotifyHandler] search-playlists error:",s.message),s}}),c.ipcMain.handle("spotify:check-saved-tracks",async(r,t)=>{try{return await g.library.checkSavedTracks(t)}catch(e){throw console.error("[SpotifyHandler] check-saved-tracks error:",e.message),e}}),c.ipcMain.handle("spotify:save-tracks",async(r,t)=>{try{return await g.library.saveTracks(t)}catch(e){throw console.error("[SpotifyHandler] save-tracks error:",e.message),e}}),c.ipcMain.handle("spotify:remove-tracks",async(r,t)=>{try{return await g.library.removeTracks(t)}catch(e){console.error("[SpotifyHandler] remove-tracks error:",e.message)}}),c.ipcMain.handle("spotify:get-home",async(r,t=20)=>{try{return await g.browse.home("Asia/Kolkata",t)}catch(e){throw console.error("[SpotifyHandler] get-home error:",e.message),e}}),c.ipcMain.handle("spotify:is-authenticated",async()=>P.isAuthenticated()),c.ipcMain.handle("spotify:get-access-token",async()=>P.accessToken),console.log("[SpotifyHandler] Initialized")}c.app.commandLine.appendSwitch("ignore-certificate-errors");const S=f.join(c.app.getPath("userData"),"audio-cache"),I=f.join(c.app.getPath("userData"),"cache-settings.json"),W={enabled:!0,maxSizeMB:500},H=()=>{u.existsSync(S)||u.mkdirSync(S,{recursive:!0})},M=()=>{try{if(u.existsSync(I)){const r=u.readFileSync(I,"utf-8");return{...W,...JSON.parse(r)}}}catch(r){console.error("Error reading cache settings:",r)}return W},$e=r=>{try{u.writeFileSync(I,JSON.stringify(r,null,2))}catch(t){console.error("Error saving cache settings:",t)}},C=()=>{H();const r=[];try{const e=u.readdirSync(S).filter(a=>a.endsWith(".meta.json"));for(const a of e){const s=a.replace(".meta.json",""),n=f.join(S,`${s}.audio`),o=f.join(S,a);if(u.existsSync(n))try{const i=JSON.parse(u.readFileSync(o,"utf-8"));r.push({key:s,metadata:i,audioPath:n})}catch{}}}catch(t){console.error("Error reading cache entries:",t)}return r},Fe=()=>C().reduce((t,e)=>t+(e.metadata.size||0),0),Q=(r,t=0)=>{const e=Fe(),a=r-t;if(e<=a)return;const s=C();s.sort((i,l)=>i.metadata.cachedAt-l.metadata.cachedAt);let n=0;const o=e-a;for(const i of s){if(n>=o)break;try{u.unlinkSync(i.audioPath),u.unlinkSync(f.join(S,`${i.key}.meta.json`)),n+=i.metadata.size,console.log(`[Cache] Evicted: ${i.key} (${i.metadata.size} bytes)`)}catch(l){console.error(`Error evicting ${i.key}:`,l)}}};c.ipcMain.handle("cache-get",async(r,t)=>{try{if(!M().enabled)return null;const a=f.join(S,`${t}.audio`);if(u.existsSync(a)){const s=u.readFileSync(a);return console.log(`[Cache] HIT: ${t}`),s.buffer}return console.log(`[Cache] MISS: ${t}`),null}catch(e){return console.error("Cache get error:",e),null}});c.ipcMain.handle("cache-put",async(r,t,e,a)=>{try{const s=M();if(!s.enabled)return!1;H();const n=s.maxSizeMB*1024*1024,o=e.byteLength;if(o>n)return console.log(`[Cache] File too large to cache: ${o} bytes`),!1;Q(n,o);const i=f.join(S,`${t}.audio`),l=f.join(S,`${t}.meta.json`),p={trackId:"",searchQuery:"",...a,cachedAt:Date.now(),size:o};return u.writeFileSync(i,Buffer.from(e)),u.writeFileSync(l,JSON.stringify(p,null,2)),console.log(`[Cache] STORED: ${t} (${o} bytes)`),!0}catch(s){return console.error("Cache put error:",s),!1}});c.ipcMain.handle("cache-delete",async(r,t)=>{try{const e=f.join(S,`${t}.audio`),a=f.join(S,`${t}.meta.json`);return u.existsSync(e)&&u.unlinkSync(e),u.existsSync(a)&&u.unlinkSync(a),console.log(`[Cache] DELETED: ${t}`),!0}catch(e){return console.error("Cache delete error:",e),!1}});c.ipcMain.handle("cache-clear",async()=>{try{H();const r=u.readdirSync(S);for(const t of r)u.unlinkSync(f.join(S,t));return console.log("[Cache] CLEARED all entries"),!0}catch(r){return console.error("Cache clear error:",r),!1}});c.ipcMain.handle("cache-stats",async()=>{try{const r=C(),t=r.reduce((e,a)=>e+a.metadata.size,0);return{count:r.length,sizeBytes:t,sizeMB:Math.round(t/(1024*1024)*100)/100}}catch(r){return console.error("Cache stats error:",r),{count:0,sizeBytes:0,sizeMB:0}}});c.ipcMain.handle("cache-settings-get",async()=>M());c.ipcMain.handle("cache-settings-set",async(r,t)=>{try{const a={...M(),...t};return $e(a),a.enabled&&t.maxSizeMB&&Q(a.maxSizeMB*1024*1024),!0}catch(e){return console.error("Cache settings save error:",e),!1}});c.ipcMain.handle("cache-list",async()=>{try{return C().map(t=>({key:t.key,trackId:t.metadata.trackId,searchQuery:t.metadata.searchQuery,cachedAt:t.metadata.cachedAt,sizeMB:Math.round(t.metadata.size/(1024*1024)*100)/100}))}catch(r){return console.error("Cache list error:",r),[]}});const O=f.join(c.app.getPath("userData"),"song-preferences.json"),D=()=>{try{if(u.existsSync(O)){const r=u.readFileSync(O,"utf-8");return JSON.parse(r)}}catch(r){console.error("Error loading song preferences:",r)}return{}},R=r=>{try{u.writeFileSync(O,JSON.stringify(r,null,2))}catch(t){console.error("Error saving song preferences:",t)}};c.ipcMain.handle("song-pref-get",async(r,t)=>{try{return D()[t]||null}catch(e){return console.error("Song pref get error:",e),null}});c.ipcMain.handle("song-pref-set",async(r,t,e)=>{try{const a=D();return a[t]={...e,savedAt:Date.now()},R(a),console.log(`[SongPref] Saved preference for: ${t}`),!0}catch(a){return console.error("Song pref set error:",a),!1}});c.ipcMain.handle("song-pref-delete",async(r,t)=>{try{const e=D();return e[t]&&(delete e[t],R(e),console.log(`[SongPref] Deleted preference for: ${t}`)),!0}catch(e){return console.error("Song pref delete error:",e),!1}});c.ipcMain.handle("song-pref-list",async()=>{try{return D()}catch(r){return console.error("Song pref list error:",r),{}}});c.ipcMain.handle("song-pref-clear",async()=>{try{return R({}),console.log("[SongPref] Cleared all preferences"),!0}catch(r){return console.error("Song pref clear error:",r),!1}});const E=f.join(c.app.getPath("userData"),"spotify-session.json"),K=r=>{try{u.writeFileSync(E,JSON.stringify(r,null,2)),console.log("[Spotify] Session saved")}catch(t){console.error("Error saving Spotify session:",t)}},X=()=>{try{if(u.existsSync(E))return JSON.parse(u.readFileSync(E,"utf-8"))}catch(r){console.error("Error loading Spotify session:",r)}return null};process.env.DIST=f.join(__dirname,"../dist");process.env.VITE_PUBLIC=c.app.isPackaged?process.env.DIST:f.join(__dirname,"../public");let y,v=null;const G=process.env.VITE_DEV_SERVER_URL,Z=!c.app.isPackaged,Ie=f.join(process.resourcesPath,"bin","yt-dlp.exe"),Oe=f.join(__dirname,"../bin/yt-dlp.exe"),L=Z?Oe:Ie;!Z&&!u.existsSync(L)&&c.dialog.showErrorBox("Critical Error",`yt-dlp.exe missing at:
${L}`);const x=r=>new Promise((t,e)=>{re.execFile(L,r,{maxBuffer:1024*1024*10},(a,s,n)=>{if(a){console.error("yt-dlp error:",n),e(a);return}try{const o=JSON.parse(s);t(o)}catch(o){console.error("JSON Parse Error:",o),e(o)}})}),j=new Map;function ee(){if(y=new c.BrowserWindow({width:1200,height:800,icon:f.join(process.env.VITE_PUBLIC||"","electron-vite.svg"),autoHideMenuBar:!0,webPreferences:{preload:f.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!1}}),y.setMenuBarVisibility(!1),y.webContents.on("did-finish-load",()=>{y?.webContents.send("main-process-message",new Date().toLocaleString())}),y.webContents.session.webRequest.onBeforeSendHeaders({urls:["*://*.youtube.com/*","*://*.googlevideo.com/*"]},(r,t)=>{const{requestHeaders:e}=r;Object.keys(e).forEach(a=>{(a.toLowerCase()==="referer"||a.toLowerCase()==="origin")&&delete e[a]}),e.Referer="https://www.youtube.com/",e.Origin="https://www.youtube.com",t({requestHeaders:e})}),y.webContents.session.webRequest.onBeforeSendHeaders({urls:["https://open.spotify.com/get_access_token*"]},(r,t)=>{t({requestHeaders:r.requestHeaders})}),y.webContents.session.on("will-download",(r,t,e)=>{const a=t.getURL(),s=j.get(a)||{filename:"audio.mp3",saveAs:!1};if(s.filename&&t.setSavePath(f.join(c.app.getPath("downloads"),s.filename)),s.saveAs){const n=c.dialog.showSaveDialogSync(y,{defaultPath:s.filename,filters:[{name:"Audio Files",extensions:["mp3","m4a"]}]});if(n)t.setSavePath(n);else{t.cancel();return}}t.on("updated",(n,o)=>{o==="progressing"&&!t.isPaused()&&y?.webContents.send("download-progress",{url:a,progress:t.getReceivedBytes()/t.getTotalBytes(),received:t.getReceivedBytes(),total:t.getTotalBytes()})}),t.on("done",(n,o)=>{j.delete(a),y?.webContents.send("download-complete",{url:a,state:o,path:t.getSavePath()})})}),G?y.loadURL(G):y.loadFile(f.join(process.env.DIST||"","index.html")),!v){const t=c.nativeImage.createFromDataURL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAADfSURBVDiNpZMxDoJAEEXfLhYmFjZewMbGxMQLeBN7C2+gd7Cx9AYcwNLL2GhjZ2dBQmICsptQCJBlJ5Ns8f/szOwfYKG1fkhBLoANsAMiYGcavsLME7AH4tQnhMBDAGugBlrmWQEBsAXutNYnM/8K7A1rlFJlEi+B+H8MEbABbrXWRynnBRb/JQihYg4wBrrm/hxomLlvYEFmDuwDG6BttN4FXGQZEAPXQNnMbcKQKaVKJdADQq31ycRChh4wABpG6x0hjYGhuT8DamYOZv6aWMjLwNDcHwNV8/cBeAe/iyFO7WBXRQAAAABJRU5ErkJggg==");v=new c.Tray(t),v.setToolTip("Ragam Music Player");const e=c.Menu.buildFromTemplate([{label:"Show App",click:()=>{y&&(y.show(),y.focus())}},{label:"Minimize to Tray",click:()=>{y?.hide()}},{type:"separator"},{label:"Play/Pause",click:()=>{y?.webContents.send("tray-playpause")}},{label:"Next Track",click:()=>{y?.webContents.send("tray-next")}},{label:"Previous Track",click:()=>{y?.webContents.send("tray-previous")}},{type:"separator"},{label:"Quit",click:()=>{c.app.quit()}}]);v.setContextMenu(e),v.on("double-click",()=>{y&&(y.show(),y.focus())})}}c.ipcMain.handle("youtube-search-video",async(r,t)=>{try{console.log(`[YouTube Video Search] Searching: ${t}`);const e=[`ytsearch5:${t}`,"--dump-single-json","--flat-playlist","--no-warnings","--no-check-certificate"],a=await x(e);return!a||!a.entries?[]:a.entries.map(s=>({id:s.id,title:s.title,thumbnail:`https://i.ytimg.com/vi/${s.id}/hqdefault.jpg`,channel:s.uploader,duration:s.duration}))}catch(e){return console.error("[YouTube Video Search] Error:",e),[]}});c.ipcMain.handle("youtube-search",async(r,t,e="US")=>{try{console.log(`[YouTube Music] Searching: ${t} (Region: ${e})`);const s=[`https://music.youtube.com/search?q=${encodeURIComponent(t)}`,"--dump-single-json","--playlist-items","1,2,3,4,5,6,7,8,9,10","--flat-playlist","--no-warnings","--no-check-certificate","--geo-bypass-country",e],n=await x(s);return!n||!n.entries?[]:n.entries.map(o=>({id:o.id,title:o.title,channelTitle:o.uploader||o.artist||"YouTube Music",duration:o.duration,thumbnail:`https://i.ytimg.com/vi/${o.id}/hqdefault.jpg`,artists:[{name:o.uploader||o.artist||"Unknown"}]}))}catch(a){console.warn("YTM Search failed, falling back to standard ytsearch:",a.message);try{const n=await x([t,"--dump-single-json","--default-search","ytsearch5:","--flat-playlist","--no-warnings","--no-check-certificate","--geo-bypass-country",e]);return!n||!n.entries?[]:n.entries.map(o=>({id:o.id,title:o.title,channelTitle:o.uploader,duration:o.duration,thumbnail:`https://i.ytimg.com/vi/${o.id}/hqdefault.jpg`,artists:[{name:o.uploader}]}))}catch(s){return console.error("Fallback Search Error:",s),[]}}});c.ipcMain.handle("youtube-stream",async(r,t,e="high")=>{try{console.log(`[YouTube] Fetching Stream for: ${t} (Quality: ${e})`);const a=`https://www.youtube.com/watch?v=${t}`;let s="bestaudio/best";e==="medium"?s="bestaudio[abr<=128]/bestaudio":e==="low"&&(s="worstaudio");const o=await x([a,"--dump-single-json","--no-warnings","--format",s,"--no-check-certificate"]);if(!o||!o.url)throw new Error("No stream URL found");return{url:o.url,duration:o.duration,title:o.title}}catch(a){return console.error("[YouTube] Stream Extraction Error:",a),null}});c.ipcMain.handle("youtube-video-url",async(r,t)=>{try{console.log(`[YouTube] Fetching HLS Stream for: ${t}`);const a=[`https://www.youtube.com/watch?v=${t}`,"--dump-single-json","--no-warnings","--no-check-certificate"],s=await x(a);let n=s.manifest_url;if(!n&&s.formats){const o=s.formats.find(i=>i.protocol==="m3u8"||i.protocol==="m3u8_native");o&&(n=o.url)}if(!n){console.log("No HLS found, falling back to MP4");const o=s.formats.reverse().find(i=>i.ext==="mp4"&&i.acodec!=="none"&&i.vcodec!=="none");n=o?o.url:s.url}if(!n)throw new Error("No video stream found");return{url:n,title:s.title,isHls:n.includes(".m3u8")}}catch(e){return console.error("[YouTube] Video Stream Error:",e),null}});c.ipcMain.handle("download-start",async(r,{url:t,filename:e,saveAs:a})=>{try{return j.set(t,{filename:e,saveAs:a}),y?.webContents.downloadURL(t),{success:!0}}catch(s){return{success:!1,error:s.message}}});c.ipcMain.handle("spotify-login",async()=>new Promise((r,t)=>{const e=new c.BrowserWindow({width:800,height:600,show:!0,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!1,contextIsolation:!0,partition:"persist:spotify_login",webSecurity:!1}}),a=e.webContents.session;a.webRequest.onBeforeRequest({urls:["*://*.spotify.com/*/service-worker.js"]},(l,p)=>{p({cancel:!0})}),e.loadURL("https://accounts.spotify.com/en/login");let s=!1,n=null;const i=setInterval(async()=>{if(!(s||e.isDestroyed()))try{const l=e.webContents.getURL();if(l.includes("accounts.spotify.com/en/status")||l.includes("open.spotify.com")){if(l.includes("accounts.spotify.com")){console.log("[Spotify Auth] Redirecting to open.spotify.com"),e.loadURL("https://open.spotify.com/");return}const p=await a.cookies.get({name:"sp_dc",url:"https://open.spotify.com"});if(p.length===0){console.log("[Spotify Auth] No sp_dc cookie yet, retrying...");return}n=p[0].value,console.log("[Spotify Auth] Got sp_dc cookie, length:",n.length),clearInterval(i),console.log("[Spotify Auth] Using TOTP authentication...");try{const d=await P.loginWithSpDc(n);if(d.success&&d.accessToken){console.log("[Spotify Auth] TOTP login successful");const h={accessToken:d.accessToken,accessTokenExpirationTimestampMs:d.expiration||Date.now()+36e5,clientId:"",isAnonymous:!1,spDcCookie:n,savedAt:Date.now()};K(h),s=!0,r(h),setTimeout(()=>{e.isDestroyed()||e.close()},500)}else throw new Error(d.error||"TOTP login failed")}catch(d){console.error("[Spotify Auth] TOTP error:",d),t(new Error(`Token fetch failed: ${d.message}`)),e.close()}}}catch(l){console.error("[Spotify Auth] Check error:",l)}},1e3);e.on("closed",()=>{clearInterval(i),s||t(new Error("Login cancelled by user"))})}));c.ipcMain.handle("spotify-refresh-token",async(r,t)=>{if(!t){const e=X();if(!e)return{success:!1,error:"No stored session"};t=e.spDcCookie}console.log("[Spotify Refresh] Using TOTP authentication...");try{const e=await P.loginWithSpDc(t);if(e.success&&e.accessToken){const a={accessToken:e.accessToken,accessTokenExpirationTimestampMs:e.expiration||Date.now()+36e5,clientId:"",isAnonymous:!1,spDcCookie:t,savedAt:Date.now()};return K(a),{success:!0,accessToken:e.accessToken,accessTokenExpirationTimestampMs:e.expiration}}else return{success:!1,error:e.error}}catch(e){return console.error("[Spotify Refresh] TOTP error:",e),{success:!1,error:e.message}}});c.ipcMain.handle("spotify-check-session",async()=>{const r=X();return r&&Date.now()<r.accessTokenExpirationTimestampMs?{success:!0,...r}:{success:!1}});c.ipcMain.handle("spotify-logout",async()=>(u.existsSync(E)&&u.unlinkSync(E),{success:!0}));c.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(c.app.quit(),y=null)});c.app.on("activate",()=>{c.BrowserWindow.getAllWindows().length===0&&ee()});c.app.whenReady().then(()=>{ce(),De(),ee()});
