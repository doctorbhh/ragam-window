"use strict";const r=require("electron"),i=require("node:path"),S=require("node:fs"),E=require("child_process");r.app.commandLine.appendSwitch("ignore-certificate-errors");process.env.DIST=i.join(__dirname,"../dist");process.env.VITE_PUBLIC=r.app.isPackaged?process.env.DIST:i.join(__dirname,"../public");let c;const m=process.env.VITE_DEV_SERVER_URL,p=!r.app.isPackaged,_=i.join(process.resourcesPath,"bin","yt-dlp.exe"),k=i.join(__dirname,"../bin/yt-dlp.exe"),d=p?k:_;!p&&!S.existsSync(d)&&r.dialog.showErrorBox("Critical Error",`yt-dlp.exe missing at:
${d}`);const b=l=>new Promise((n,e)=>{E.execFile(d,l,{maxBuffer:1024*1024*10},(t,o,w)=>{if(t){console.error("yt-dlp error:",w),e(t);return}try{const s=JSON.parse(o);n(s)}catch(s){console.error("JSON Parse Error:",s),e(s)}})});function y(){c=new r.BrowserWindow({width:1200,height:800,icon:i.join(process.env.VITE_PUBLIC||"","electron-vite.svg"),webPreferences:{preload:i.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!1}}),c.webContents.on("did-finish-load",()=>{c?.webContents.send("main-process-message",new Date().toLocaleString())}),m?c.loadURL(m):c.loadFile(i.join(process.env.DIST||"","index.html"))}r.ipcMain.handle("youtube-search",async(l,n)=>{try{console.log(`[YouTube] Searching for: ${n}`);const t=await b([n,"--dump-single-json","--default-search","ytsearch5:","--flat-playlist","--no-warnings"]);return!t||!t.entries?[]:t.entries.map(o=>({id:o.id,title:o.title,channelTitle:o.uploader,duration:o.duration,thumbnail:o.thumbnail||`https://i.ytimg.com/vi/${o.id}/hqdefault.jpg`,artists:[{name:o.uploader}]}))}catch(e){return console.error("[YouTube] Search Error:",e),p||r.dialog.showErrorBox("Search Error",`Failed to run yt-dlp:
${e.message}
Path: ${d}`),[]}});r.ipcMain.handle("youtube-stream",async(l,n)=>{try{console.log(`[YouTube] Fetching Stream for: ${n}`);const t=[`https://www.youtube.com/watch?v=${n}`,"--dump-single-json","--no-warnings","--format","bestaudio/best"],o=await b(t);if(!o||!o.url)throw new Error("No stream URL found");return{url:o.url,duration:o.duration,title:o.title}}catch(e){return console.error("[YouTube] Stream Extraction Error:",e),p||r.dialog.showErrorBox("Stream Error",`Failed to play song:
${e.message}
Path: ${d}`),null}});r.ipcMain.handle("spotify-login",async()=>new Promise((l,n)=>{const e=new r.BrowserWindow({width:800,height:600,show:!0,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!1,contextIsolation:!0,partition:"persist:spotify_login",webSecurity:!1}}),t=e.webContents.session;t.webRequest.onBeforeRequest({urls:["*://*.spotify.com/*/service-worker.js"]},(a,u)=>{u({cancel:!0})}),e.loadURL("https://accounts.spotify.com/en/login");let o=!1;const s=setInterval(async()=>{if(!(o||e.isDestroyed()))try{(await t.cookies.get({name:"sp_dc"})).length>0&&e.webContents.getURL().includes("accounts.spotify.com")&&(console.log("Login Cookie found! Redirecting to Player..."),clearInterval(s),await e.loadURL("https://open.spotify.com"))}catch(a){console.error("Cookie check error:",a)}},1e3);try{e.webContents.debugger.attach("1.3")}catch(a){console.error("Debugger attach failed",a)}e.webContents.debugger.on("message",async(a,u,g)=>{if(u==="Network.responseReceived"&&g.response.url.includes("/api/token"))try{const h=await e.webContents.debugger.sendCommand("Network.getResponseBody",{requestId:g.requestId});if(h.body){const f=JSON.parse(h.body);f.accessToken&&(console.log(">>> SUCCESS: Token Sniffed!"),o=!0,l(f),setTimeout(()=>{e.isDestroyed()||e.close()},500))}}catch{}}),e.webContents.debugger.sendCommand("Network.enable"),e.on("closed",()=>{clearInterval(s),o||console.log("Auth window closed by user")})}));r.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(r.app.quit(),c=null)});r.app.on("activate",()=>{r.BrowserWindow.getAllWindows().length===0&&y()});r.app.whenReady().then(y);
